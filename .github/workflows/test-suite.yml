name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:
  # schedule:
  #   # Run tests weekly on Monday at 2 AM UTC
  #   - cron: '0 2 * * 1'

env:
  # Environment
  TMWS_ENVIRONMENT: test
  TMWS_SECRET_KEY: "test_secret_key_for_ci_pipeline_at_least_32_characters_long"
  TMWS_AUTH_ENABLED: "false"  # Disable auth for testing

  # Database
  TMWS_DATABASE_URL: "postgresql://postgres:postgres@localhost:5432/tmws_test"
  TEST_USE_POSTGRESQL: "true"

  # Redis (optional for tests)
  TMWS_REDIS_URL: "redis://localhost:6379/0"

  # Python version
  PYTHON_VERSION: "3.11"

  # Testing
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

jobs:
  test:
    name: "Test Suite"
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:0.8.1-pg17
        env:
          POSTGRES_DB: tmws_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Setup PostgreSQL with pgvector
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d tmws_test -c "CREATE EXTENSION IF NOT EXISTS pgvector;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d tmws_test -c "CREATE EXTENSION IF NOT EXISTS uuid-ossp;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d tmws_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip wheel setuptools
          pip install -e ".[dev]"

      - name: Run database migrations
        run: |
          alembic upgrade head

      - name: Lint with Ruff
        run: |
          ruff check . --output-format=github
        continue-on-error: true  # Don't fail the build on lint errors

      - name: Check formatting with Ruff
        run: |
          ruff format --check .
        continue-on-error: true  # Don't fail the build on format issues

      - name: Type checking with mypy
        run: |
          mypy src --ignore-missing-imports
        continue-on-error: true  # Don't fail on type errors for now

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v --cov=src --cov-report=term-missing --cov-report=xml --cov-report=html

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --cov=src --cov-report=term-missing --cov-append

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true  # Don't fail if codecov is down

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            htmlcov/
            coverage.xml
            junit.xml
          retention-days: 30

  security:
    name: "Security Scan"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Security scan with Bandit
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "## Bandit Security Report" >> $GITHUB_STEP_SUMMARY
            python -m json.tool bandit-report.json >> $GITHUB_STEP_SUMMARY || true
          fi
        continue-on-error: true

      - name: Check dependencies with Safety
        run: |
          safety check --json || true
        continue-on-error: true

      - name: Audit dependencies with pip-audit
        run: |
          pip-audit || true
        continue-on-error: true

  notify:
    name: "Notify Status"
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always()

    steps:
      - name: Check status
        run: |
          echo "## Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "- Test Status: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Status: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.test.result }}" == "failure" ]; then
            echo "⚠️ Tests failed. Please check the logs." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          fi