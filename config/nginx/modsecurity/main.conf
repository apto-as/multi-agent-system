# ModSecurity Configuration for TMWS Production
# Hestia Security Implementation - Comprehensive WAF Rules
# Based on OWASP ModSecurity Core Rule Set (CRS) 3.3

# ================================
# ModSecurity Engine Configuration
# ================================
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecRequestBodyLimit 52428800
SecRequestBodyNoFilesLimit 1048576
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# ================================
# Audit Logging
# ================================
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/modsecurity/audit.log
SecAuditLogFormat JSON

# ================================
# Debug Logging (Disable in production)
# ================================
SecDebugLog /var/log/modsecurity/debug.log
SecDebugLogLevel 0

# ================================
# Temporary Directory
# ================================
SecTmpDir /tmp/
SecDataDir /tmp/

# ================================
# Response Codes and Actions
# ================================
SecDefaultAction "phase:1,log,auditlog,pass"
SecAction "id:900001,phase:1,pass,nolog,ctl:ruleEngine=On"

# ================================
# Custom Rule Set - TMWS Specific
# ================================

# Block requests with no User-Agent or suspicious User-Agents
SecRule REQUEST_HEADERS:User-Agent "^$" \
    "id:1001,\
     phase:1,\
     block,\
     msg:'Empty User-Agent',\
     logdata:'User-Agent: %{REQUEST_HEADERS.user-agent}',\
     tag:'attack-generic',\
     severity:'WARNING'"

SecRule REQUEST_HEADERS:User-Agent "@rx (?i:(?:sqlmap|nikto|nmap|masscan|burp|zap|acunetix|nessus|openvas|w3af|skipfish|havij))" \
    "id:1002,\
     phase:1,\
     block,\
     msg:'Security Scanner Detected',\
     logdata:'User-Agent: %{REQUEST_HEADERS.user-agent}',\
     tag:'attack-scanner',\
     severity:'CRITICAL'"

# Block common SQL injection patterns
SecRule ARGS "@rx (?i:(?:union(?:\s+all)?\s+select|select.*from|insert.*into|delete.*from|update.*set|drop\s+(?:table|database)|create\s+(?:table|database)|alter\s+table|exec(?:ute)?\s*\(|eval\s*\(|script\s*\())" \
    "id:1003,\
     phase:2,\
     block,\
     msg:'SQL Injection Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-sqli',\
     severity:'CRITICAL'"

# Block XSS patterns
SecRule ARGS "@rx (?i:(?:<\s*script[^>]*>|<\s*\/\s*script\s*>|javascript\s*:|on(?:load|error|click|mouseover|focus)\s*=|<\s*(?:iframe|frame|object|embed|meta)\s*[^>]*>|expression\s*\(|url\s*\(|@import))" \
    "id:1004,\
     phase:2,\
     block,\
     msg:'Cross-Site Scripting (XSS) Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-xss',\
     severity:'CRITICAL'"

# Block command injection patterns
SecRule ARGS "@rx (?i:(?:;?\s*(?:cat|ls|pwd|whoami|id|uname|ps|netstat|ifconfig|ping|wget|curl|nc|telnet|ssh|ftp)\s*[;&|]?|(?:&&|\|\|)|\$\(|\`|<%|\${|#\{))" \
    "id:1005,\
     phase:2,\
     block,\
     msg:'Command Injection Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-injection',\
     severity:'CRITICAL'"

# Block directory traversal attacks
SecRule ARGS "@rx (?i:(?:\.\.\/|\.\.\\|\/etc\/|\/bin\/|\/usr\/|\/var\/|\/tmp\/|\/proc\/|\/sys\/|c:\\\\|d:\\\\|\.\.%2f|\.\.%5c))" \
    "id:1006,\
     phase:2,\
     block,\
     msg:'Directory Traversal Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-traversal',\
     severity:'HIGH'"

# Block PHP/ASP code injection
SecRule ARGS "@rx (?i:(?:<\?php|<%|<\?=|eval\s*\(|base64_decode|file_get_contents|system\s*\(|exec\s*\(|shell_exec|passthru|proc_open))" \
    "id:1007,\
     phase:2,\
     block,\
     msg:'Code Injection Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-code-injection',\
     severity:'CRITICAL'"

# Block LDAP injection
SecRule ARGS "@rx (?i:(?:\(\s*\|\s*\(|\)\s*\(\s*\||\*\s*\)\s*\(|\&\s*\(\s*objectclass\s*=|admin\)\s*\(\s*\||password\)\s*\(\s*\|))" \
    "id:1008,\
     phase:2,\
     block,\
     msg:'LDAP Injection Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-ldap-injection',\
     severity:'HIGH'"

# Block XML/XXE attacks
SecRule REQUEST_BODY "@rx (?i:(?:<!ENTITY|<!DOCTYPE.*ENTITY|SYSTEM\s+['\"][^'\"]*\.dtd|PUBLIC\s+['\"].*['\"].*['\"][^'\"]*\.dtd))" \
    "id:1009,\
     phase:2,\
     block,\
     msg:'XML External Entity (XXE) Attack',\
     logdata:'Body: %{MATCHED_VAR}',\
     tag:'attack-xxe',\
     severity:'HIGH'"

# Block SSRF patterns
SecRule ARGS "@rx (?i:(?:https?:\/\/(?:localhost|127\.0\.0\.1|0\.0\.0\.0|::1|0x7f000001|2130706433|017700000001)|file:\/\/|dict:\/\/|ftp:\/\/|gopher:\/\/|ldap:\/\/|tftp:\/\/))" \
    "id:1010,\
     phase:2,\
     block,\
     msg:'Server-Side Request Forgery (SSRF) Attack',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',\
     tag:'attack-ssrf',\
     severity:'HIGH'"

# ================================
# Rate Limiting per IP
# ================================
SecAction "id:1100,phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR},setvar:ip.requests_per_minute=+1,expirevar:ip.requests_per_minute=60"
SecRule IP:REQUESTS_PER_MINUTE "@gt 120" \
    "id:1101,\
     phase:1,\
     block,\
     msg:'Rate Limit Exceeded - Too Many Requests',\
     logdata:'IP: %{REMOTE_ADDR}, Requests: %{IP.requests_per_minute}',\
     tag:'rate-limit',\
     severity:'WARNING'"

# ================================
# Authentication Endpoint Protection
# ================================
SecRule REQUEST_URI "@rx ^/api/v1/(auth|login|register)" \
    "id:1200,\
     phase:1,\
     nolog,\
     pass,\
     initcol:ip=%{REMOTE_ADDR},\
     setvar:ip.auth_attempts=+1,\
     expirevar:ip.auth_attempts=300"

SecRule IP:AUTH_ATTEMPTS "@gt 10" \
    "id:1201,\
     phase:1,\
     block,\
     msg:'Authentication Brute Force Attack',\
     logdata:'IP: %{REMOTE_ADDR}, Attempts: %{IP.auth_attempts}',\
     tag:'attack-brute-force',\
     severity:'CRITICAL'"

# ================================
# Request Validation
# ================================

# Ensure Content-Type is present for POST/PUT requests
SecRule REQUEST_METHOD "@rx ^(?:POST|PUT)$" \
    "id:1300,\
     phase:1,\
     chain,\
     msg:'Missing Content-Type Header'"

SecRule &REQUEST_HEADERS:Content-Type "@eq 0" \
    "block,\
     logdata:'Method: %{REQUEST_METHOD}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# Block requests with suspicious Content-Type
SecRule REQUEST_HEADERS:Content-Type "!@rx ^(?:application/json|multipart/form-data|application/x-www-form-urlencoded)" \
    "id:1301,\
     phase:1,\
     block,\
     msg:'Invalid Content-Type',\
     logdata:'Content-Type: %{REQUEST_HEADERS.content-type}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# Validate JSON payloads
SecRule REQUEST_HEADERS:Content-Type "@rx application/json" \
    "id:1302,\
     phase:2,\
     chain,\
     msg:'Invalid JSON Payload'"

SecRule REQUEST_BODY "@validateByteRange 32-126" \
    "t:none,\
     block,\
     logdata:'Body: %{REQUEST_BODY}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# ================================
# File Upload Security
# ================================
SecRule FILES_TMPNAMES "@inspectFile /etc/modsecurity/file_inspector.lua" \
    "id:1400,\
     phase:2,\
     block,\
     msg:'Malicious File Upload Detected',\
     logdata:'File: %{FILES.filename}',\
     tag:'attack-file-upload',\
     severity:'CRITICAL'"

# Block dangerous file extensions
SecRule FILES "@rx (?i:\.(?:exe|scr|pif|application|gadget|msi|msp|com|scf|lnk|cmd|bat|psd1|ps1|vbs|js|jar|php|asp|aspx|jsp|cgi|pl|py|rb|sh))$" \
    "id:1401,\
     phase:2,\
     block,\
     msg:'Dangerous File Extension Uploaded',\
     logdata:'File: %{FILES.filename}',\
     tag:'attack-file-upload',\
     severity:'HIGH'"

# ================================
# Geographic Restrictions (Example)
# ================================
# Note: This requires GeoIP integration
SecRule GEO:COUNTRY_CODE "@rx ^(?:CN|RU|KP)$" \
    "id:1500,\
     phase:1,\
     block,\
     msg:'Request from Blocked Country',\
     logdata:'Country: %{GEO.country_code}, IP: %{REMOTE_ADDR}',\
     tag:'geo-block',\
     severity:'INFO'"

# ================================
# Anomaly Scoring
# ================================
SecAction "id:1900,phase:1,nolog,pass,setvar:tx.anomaly_score_threshold=5"
SecAction "id:1901,phase:1,nolog,pass,setvar:tx.critical_anomaly_score=5"
SecAction "id:1902,phase:1,nolog,pass,setvar:tx.error_anomaly_score=4"
SecAction "id:1903,phase:1,nolog,pass,setvar:tx.warning_anomaly_score=3"
SecAction "id:1904,phase:1,nolog,pass,setvar:tx.notice_anomaly_score=2"

# Critical anomaly score increment
SecRule TX:ANOMALY_SCORE "@ge %{tx.critical_anomaly_score}" \
    "id:1905,\
     phase:2,\
     block,\
     msg:'Critical Anomaly Score Exceeded: %{TX.ANOMALY_SCORE}',\
     logdata:'Total Score: %{TX.ANOMALY_SCORE}',\
     tag:'anomaly-evaluation',\
     severity:'CRITICAL'"

# ================================
# Custom Blocking Rules for TMWS
# ================================

# Block access to sensitive paths
SecRule REQUEST_URI "@rx ^\/(?:admin|\.env|config|backup|database|logs|keys|secrets|vault)" \
    "id:2000,\
     phase:1,\
     block,\
     msg:'Access to Sensitive Path Blocked',\
     logdata:'URI: %{REQUEST_URI}',\
     tag:'attack-sensitive-path',\
     severity:'HIGH'"

# Block requests to non-existent API versions
SecRule REQUEST_URI "@rx ^\/api\/v(?!1\b)" \
    "id:2001,\
     phase:1,\
     block,\
     msg:'Access to Non-existent API Version',\
     logdata:'URI: %{REQUEST_URI}',\
     tag:'protocol-violation',\
     severity:'INFO'"

# Block oversized headers
SecRule REQUEST_HEADERS:User-Agent "@gt 512" \
    "id:2002,\
     phase:1,\
     block,\
     msg:'Oversized User-Agent Header',\
     logdata:'User-Agent length: %{REQUEST_HEADERS.user-agent}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# Block requests with too many parameters
SecRule &ARGS "@gt 50" \
    "id:2003,\
     phase:2,\
     block,\
     msg:'Too Many Parameters',\
     logdata:'Parameter count: %{&ARGS}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# Block extremely long parameter values
SecRule ARGS "@gt 4096" \
    "id:2004,\
     phase:2,\
     block,\
     msg:'Parameter Value Too Long',\
     logdata:'Parameter: %{MATCHED_VAR_NAME}, Length: %{MATCHED_VAR}',\
     tag:'protocol-violation',\
     severity:'WARNING'"

# ================================
# Whitelist Rules (Exceptions)
# ================================

# Allow health check endpoint
SecRule REQUEST_URI "@streq /health" \
    "id:3000,\
     phase:1,\
     nolog,\
     pass,\
     ctl:ruleEngine=Off"

# Allow internal monitoring
SecRule REMOTE_ADDR "@ipMatch 172.20.0.0/16" \
    "id:3001,\
     phase:1,\
     chain,\
     nolog,\
     pass"

SecRule REQUEST_URI "@rx ^\/(?:health|metrics|status)" \
    "ctl:ruleEngine=Off"

# ================================
# Response Body Filtering
# ================================
SecResponseBodyAccess On
SecResponseBodyMimeType text/html text/plain application/json

# Filter sensitive information in responses
SecRule RESPONSE_BODY "@rx (?i:password|secret|key|token|credential)" \
    "id:4000,\
     phase:4,\
     log,\
     msg:'Sensitive Information in Response',\
     tag:'info-leak',\
     severity:'WARNING'"

# ================================
# Collection Timeout
# ================================
SecCollectionTimeout 600

# ================================
# Error Handling
# ================================
SecRule TX:EXECUTING_PARANOIA_LEVEL "@lt 1" "id:901011,phase:1,pass,nolog,skipAfter:END-REQUEST-901-INITIALIZATION"
SecRule TX:EXECUTING_PARANOIA_LEVEL "@lt 2" "id:901012,phase:1,pass,nolog,skipAfter:END-REQUEST-902-NONSTANDARD-CUSTOM"
SecRule TX:EXECUTING_PARANOIA_LEVEL "@lt 3" "id:901013,phase:1,pass,nolog,skipAfter:END-REQUEST-903-IP-REPUTATION"
SecRule TX:EXECUTING_PARANOIA_LEVEL "@lt 4" "id:901014,phase:1,pass,nolog,skipAfter:END-REQUEST-904-SCANNING-DETECTION"

SecMarker "END-REQUEST-901-INITIALIZATION"
SecMarker "END-REQUEST-902-NONSTANDARD-CUSTOM" 
SecMarker "END-REQUEST-903-IP-REPUTATION"
SecMarker "END-REQUEST-904-SCANNING-DETECTION"

# ================================
# Final Rules
# ================================
SecRule TX:ANOMALY_SCORE "@ge %{tx.anomaly_score_threshold}" \
    "id:9001,\
     phase:2,\
     block,\
     msg:'Anomaly Score Exceeded (Total Score: %{TX.ANOMALY_SCORE})',\
     tag:'anomaly-evaluation'"