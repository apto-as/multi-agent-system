# ========================================
# TMWS v2.4.0 - Mac Hybrid Mode
# ========================================
# Architecture:
#   - Ollama: Native (host, Metal GPU acceleration)
#   - TMWS: Docker container
# Connection: http://host.docker.internal:11434
# ========================================

services:
  tmws:
    # Use pre-built image from GitHub Container Registry
    image: ghcr.io/apto-as/tmws:latest

    container_name: tmws-app
    hostname: tmws

    # STDIO MCP Server Requirements (Phase 4.2: Critical for interactive mode)
    tty: true           # Allocate pseudo-TTY for STDIO mode
    stdin_open: true    # Keep STDIN open for interactive MCP server

    # Load environment variables from .env file
    env_file:
      - .env

    ports:
      # MCP Server API
      - "8000:8000"

    volumes:
      # Consolidated TMWS data directory (Phase 2E-3: FORTRESS CONSOLIDATION)
      # Contains: db/, secrets/, logs/, vector_store/, output/
      - ./.tmws:/app/.tmws

      # Configuration files (kept separate for easy editing)
      - ./config:/app/config

      # Trinitas agent files (Phase 4.2: Agent file delivery to Claude Desktop)
      # Bidirectional sync: Container generates .md files â†’ Host reads them
      - ~/.claude/agents:/home/tmws/.claude/agents

    environment:
      # Environment
      - TMWS_ENVIRONMENT=${TMWS_ENVIRONMENT:-production}

      # Security (REQUIRED - set in .env)
      - TMWS_SECRET_KEY=${TMWS_SECRET_KEY}

      # Database (Phase 2E-3: Consolidated path)
      - TMWS_DATABASE_URL=sqlite+aiosqlite:////app/.tmws/db/tmws.db

      # Ollama (Mac Native - Metal GPU)
      # host.docker.internal resolves to host machine
      - TMWS_OLLAMA_BASE_URL=http://host.docker.internal:11434
      - TMWS_OLLAMA_MODEL=zylonai/multilingual-e5-large

      # ChromaDB (Phase 2E-3: Consolidated path)
      - TMWS_CHROMA_PERSIST_DIRECTORY=/app/.tmws/vector_store

      # Logging (Phase 2E-3: Consolidated path)
      - TMWS_LOG_LEVEL=${TMWS_LOG_LEVEL:-INFO}
      - TMWS_LOG_FILE=/app/.tmws/logs/tmws.log

      # CORS (if needed for web clients)
      - TMWS_CORS_ORIGINS=${TMWS_CORS_ORIGINS:-["http://localhost:3000"]}

      # Performance
      - TMWS_MAX_WORKERS=${TMWS_MAX_WORKERS:-4}
      - TMWS_REQUEST_TIMEOUT=${TMWS_REQUEST_TIMEOUT:-60}

    restart: unless-stopped

    # Healthcheck disabled for STDIO MCP server (no HTTP endpoint)
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 30s

    # Resource limits (recommended for production)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

    # Network
    networks:
      - tmws-network

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  tmws-network:
    driver: bridge

# ========================================
# Setup Instructions (Mac)
# ========================================
# 1. Install Ollama (native):
#    brew install ollama
#    OR download from https://ollama.ai/download
#
# 2. Start Ollama (Metal GPU acceleration):
#    ollama serve
#
# 3. Pull embedding model:
#    ollama pull zylonai/multilingual-e5-large
#
# 4. Create .env file:
#    cp .env.example .env
#    # Edit .env and set TMWS_SECRET_KEY
#
# 5. Create directories:
#    mkdir -p data config logs .chroma
#
# 6. Start TMWS:
#    docker-compose -f docker-compose.mac.yml up -d
#
# 7. Verify:
#    docker-compose -f docker-compose.mac.yml ps
#    docker-compose -f docker-compose.mac.yml logs -f
#    curl http://localhost:8000/health
#
# ========================================
# Troubleshooting
# ========================================
# Ollama connection error:
#   - Verify Ollama is running: curl http://localhost:11434/api/tags
#   - Check model: ollama list | grep multilingual-e5-large
#
# Permission denied on volumes:
#   chmod -R 755 data config logs .chroma
#
# Container unhealthy:
#   docker-compose -f docker-compose.mac.yml logs tmws
#   docker exec -it tmws-app /bin/bash
#
# Reset everything:
#   docker-compose -f docker-compose.mac.yml down -v
#   rm -rf data/.chroma/* data/*.db logs/*
#   docker-compose -f docker-compose.mac.yml up -d
# ========================================
