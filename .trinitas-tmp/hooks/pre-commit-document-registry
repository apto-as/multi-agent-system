#!/usr/bin/env bash
#
# Git Pre-commit Hook: Document Registry Validation
#
# Purpose: Automatically validate and update document registry
# Created: 2025-11-03
# Created by: Artemis (Technical Perfectionist)
#
# Performance Target: < 2 seconds for typical commit
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Configuration
REPO_ROOT=$(git rev-parse --show-toplevel)
REGISTRY_SCRIPT="$REPO_ROOT/scripts/update_document_registry.py"
REGISTRY_FILE="$REPO_ROOT/docs/DOCUMENT_REGISTRY.yaml"
LOG_FILE="$REPO_ROOT/logs/document_registry_hook.log"

# Create logs directory if needed
mkdir -p "$(dirname "$LOG_FILE")"

echo "üîç Checking document registry..." | tee -a "$LOG_FILE"

# Get list of staged documentation files
STAGED_DOCS=$(git diff --cached --name-only --diff-filter=ACM | \
    grep -E '^(docs|trinitas_sources)/.*\.(md|yaml|json)$' || true)

if [ -z "$STAGED_DOCS" ]; then
    echo "‚úÖ No documentation files changed" | tee -a "$LOG_FILE"
    exit 0
fi

echo "üìÑ Found changed documentation files:" | tee -a "$LOG_FILE"
echo "$STAGED_DOCS" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

# Check if registry script exists
if [ ! -f "$REGISTRY_SCRIPT" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Registry script not found: $REGISTRY_SCRIPT${NC}" | tee -a "$LOG_FILE"
    echo -e "${YELLOW}‚ö†Ô∏è  Skipping registry validation${NC}" | tee -a "$LOG_FILE"
    exit 0
fi

# Make script executable
chmod +x "$REGISTRY_SCRIPT"

# Performance tracking
START_TIME=$(date +%s)

# Step 1: Update registry for changed files
echo "üìù Updating registry for changed files..." | tee -a "$LOG_FILE"

for file in $STAGED_DOCS; do
    if [ -f "$REPO_ROOT/$file" ]; then
        echo "  Processing: $file" | tee -a "$LOG_FILE"

        # Add to registry (non-interactive mode)
        if ! python3 "$REGISTRY_SCRIPT" add "$REPO_ROOT/$file" --non-interactive >> "$LOG_FILE" 2>&1; then
            echo -e "${YELLOW}‚ö†Ô∏è  Warning: Could not update registry for $file${NC}" | tee -a "$LOG_FILE"
        fi
    fi
done

# Step 2: Validate registry
echo "" | tee -a "$LOG_FILE"
echo "üîç Validating registry integrity..." | tee -a "$LOG_FILE"

if ! python3 "$REGISTRY_SCRIPT" validate >> "$LOG_FILE" 2>&1; then
    echo -e "${RED}‚ùå Registry validation failed${NC}" | tee -a "$LOG_FILE"
    echo -e "${RED}‚ùå Please fix the errors and try again${NC}" | tee -a "$LOG_FILE"
    echo "" | tee -a "$LOG_FILE"

    # Show validation errors
    python3 "$REGISTRY_SCRIPT" validate 2>&1 | tail -20

    exit 1
fi

# Step 3: Regenerate index
echo "" | tee -a "$LOG_FILE"
echo "üìö Regenerating INDEX.md..." | tee -a "$LOG_FILE"

if ! python3 "$REGISTRY_SCRIPT" index >> "$LOG_FILE" 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Could not regenerate index${NC}" | tee -a "$LOG_FILE"
fi

# Step 4: Stage updated registry and index
if [ -f "$REGISTRY_FILE" ]; then
    git add "$REGISTRY_FILE" >> "$LOG_FILE" 2>&1
    echo "‚úÖ Staged updated registry" | tee -a "$LOG_FILE"
fi

if [ -f "$REPO_ROOT/docs/INDEX.md" ]; then
    git add "$REPO_ROOT/docs/INDEX.md" >> "$LOG_FILE" 2>&1
    echo "‚úÖ Staged updated index" | tee -a "$LOG_FILE"
fi

# Performance report
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "" | tee -a "$LOG_FILE"
echo -e "${GREEN}‚úÖ Document registry validation completed in ${DURATION}s${NC}" | tee -a "$LOG_FILE"

# Performance threshold check
if [ "$DURATION" -gt 5 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Hook took longer than expected (${DURATION}s > 5s)${NC}" | tee -a "$LOG_FILE"
    echo -e "${YELLOW}‚ö†Ô∏è  Consider optimizing the registry script${NC}" | tee -a "$LOG_FILE"
fi

exit 0
