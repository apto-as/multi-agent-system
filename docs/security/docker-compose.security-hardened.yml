# ========================================
# TMWS Security-Hardened Docker Compose
# Hestia Security Audit: 2025-11-29
# ========================================
# ğŸ”¥ ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¨å¥¨è¨­å®šä¾‹ã§ã™
# æœ¬ç•ªç’°å¢ƒã§ã¯ç’°å¢ƒã«å¿œã˜ã¦ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„
# ========================================

version: '3.8'

networks:
  tmws_internal:
    driver: bridge
    # ğŸ”¥ å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦è¨­å®šï¼ˆå¤–éƒ¨é€šä¿¡ã¯Ollamaã®ã¿ï¼‰
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1

services:
  tmws:
    image: tmws:latest
    container_name: tmws_production

    # ğŸ”¥ éç‰¹æ¨©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
    user: "1000:1000"

    # ğŸ”¥ èª­ã¿å–ã‚Šå°‚ç”¨ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ›¸ãè¾¼ã¿ã¯ç‰¹å®šãƒœãƒªãƒ¥ãƒ¼ãƒ ã®ã¿ï¼‰
    read_only: true

    # ğŸ”¥ Linux capabilitiesæœ€å°åŒ–
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # ãƒãƒ¼ãƒˆ8000ãƒã‚¤ãƒ³ãƒ‰ç”¨

    # ğŸ”¥ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    security_opt:
      - no-new-privileges:true  # æ¨©é™æ˜‡æ ¼ç¦æ­¢
      - seccomp:unconfined  # æœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªseccompãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨

    # ğŸ”¥ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
    networks:
      tmws_internal:
        ipv4_address: 172.20.0.10

    # ğŸ”¥ ãƒãƒ¼ãƒˆå…¬é–‹ï¼ˆlocalhostã®ã¿ãƒã‚¤ãƒ³ãƒ‰ï¼‰
    ports:
      - "127.0.0.1:8000:8000"

    # ğŸ”¥ ç’°å¢ƒå¤‰æ•°ï¼ˆ.envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    env_file:
      - .env.production  # æœ¬ç•ªç”¨

    environment:
      # Ollamaã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ›ã‚¹ãƒˆã¾ãŸã¯åˆ¥ã‚³ãƒ³ãƒ†ãƒŠï¼‰
      TMWS_OLLAMA_BASE_URL: "http://host.docker.internal:11434"

      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
      TMWS_SECURITY_HEADERS_ENABLED: "true"
      TMWS_SESSION_TIMEOUT: "3600"
      TMWS_MAX_REQUEST_SIZE: "10485760"

      # ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯INFOæ¨å¥¨ï¼‰
      TMWS_LOG_LEVEL: "INFO"

    # ğŸ”¥ ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆï¼ˆæ›¸ãè¾¼ã¿å¯èƒ½ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã¿ï¼‰
    volumes:
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆæ°¸ç¶šåŒ–ï¼‰
      - type: volume
        source: tmws_db
        target: /app/.tmws/db

      # ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ï¼ˆæ°¸ç¶šåŒ–ï¼‰
      - type: volume
        source: tmws_vector
        target: /app/.tmws/vector_store

      # ãƒ­ã‚°ï¼ˆæ°¸ç¶šåŒ–ï¼‰
      - type: volume
        source: tmws_logs
        target: /app/.tmws/logs

      # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸€æ™‚é ˜åŸŸï¼‰
      - type: tmpfs
        target: /app/.tmws/output
        tmpfs:
          size: 100M
          mode: 0700

      # ğŸ”¥ tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãƒ«ãƒ¼ãƒˆFSå¯¾å¿œï¼‰
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 50M
          mode: 1777

    # ğŸ”¥ ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ï¼ˆDoSé˜²æ­¢ï¼‰
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

    # ğŸ”¥ å†èµ·å‹•ãƒãƒªã‚·ãƒ¼
    restart: unless-stopped

    # ğŸ”¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆSTDIOãƒ¢ãƒ¼ãƒ‰ã§ã¯ç„¡åŠ¹åŒ–ï¼‰
    # HTTPãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯æœ‰åŠ¹åŒ–ã—ã¦ãã ã•ã„
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 30s

    # ğŸ”¥ ãƒ­ã‚°è¨­å®šï¼ˆãƒ­ã‚°ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=tmws,environment=production"

volumes:
  # ğŸ”¥ ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®æ˜ç¤ºçš„å®šç¾©
  tmws_db:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/db
      o: bind

  tmws_vector:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/vector_store
      o: bind

  tmws_logs:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/data/logs
      o: bind
