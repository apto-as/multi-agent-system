# Claude Desktop MCP Setup for TMWS v2.3.0

## Option A: Hybrid uvx Approach (Recommended)

This guide explains how to set up TMWS v2.3.0 as an MCP server for Claude Desktop using the hybrid uvx approach.

### Prerequisites

- Python 3.11+
- uv package manager
- Redis (running)
- PostgreSQL with pgvector (Supabase recommended)
- Claude Desktop

### Installation Steps

#### 1. Run Setup Script

```bash
cd /path/to/tmws
./setup_tmws_mcp.sh
```

This script will:
- Clone TMWS to `~/.tmws-repo` (separate from development directory)
- Install dependencies with `uv sync`
- Create data directories for ChromaDB
- Generate `.env` configuration
- Run database migrations (optional)
- Initialize ChromaDB (optional)
- Offer to auto-configure Claude Desktop

#### 2. Configure Environment

Edit `~/.tmws-repo/.env`:

```bash
vim ~/.tmws-repo/.env
```

**Required settings:**

```ini
# === DATABASE (PostgreSQL + pgvector) ===
# Replace with your Supabase/PostgreSQL connection string
TMWS_DATABASE_URL=postgresql://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres

# === REDIS ===
TMWS_REDIS_URL=redis://localhost:6379/0

# === CHROMADB ===
TMWS_CHROMA_PERSIST_DIRECTORY=/Users/yourusername/.tmws-repo/data/chroma
TMWS_CHROMA_COLLECTION=tmws_memories
TMWS_CHROMA_CACHE_SIZE=10000

# === SECURITY ===
# Auto-generated secure key (keep this secret!)
TMWS_SECRET_KEY=<auto-generated-key>
```

#### 3. Configure Claude Desktop

Edit Claude Desktop MCP configuration:

```bash
vim ~/Library/Application\ Support/Claude/claude_desktop_config.json
```

**Add TMWS server:**

```json
{
  "mcpServers": {
    "tmws": {
      "command": "uvx",
      "args": [
        "--from",
        "/Users/yourusername/.tmws-repo",
        "tmws-mcp-server"
      ],
      "env": {
        "TMWS_DATABASE_URL": "postgresql://postgres.xxxxx:password@aws-0-ap-northeast-1.pooler.supabase.com:5432/postgres",
        "TMWS_REDIS_URL": "redis://localhost:6379/0",
        "TMWS_CHROMA_PERSIST_DIRECTORY": "/Users/yourusername/.tmws-repo/data/chroma",
        "TMWS_SECRET_KEY": "your-secret-key-from-env-file",
        "TMWS_ENVIRONMENT": "production",
        "TMWS_VECTOR_DIMENSION": "768",
        "TMWS_EMBEDDING_MODEL": "intfloat/multilingual-e5-base"
      }
    }
  }
}
```

**Environment Variables Explanation:**

| Variable | Required | Description | Example |
|----------|----------|-------------|---------|
| `TMWS_DATABASE_URL` | ✅ Yes | PostgreSQL connection string | `postgresql://user:pass@host/db` |
| `TMWS_REDIS_URL` | ✅ Yes | Redis connection string | `redis://localhost:6379/0` |
| `TMWS_CHROMA_PERSIST_DIRECTORY` | ✅ Yes | ChromaDB data directory | `~/.tmws-repo/data/chroma` |
| `TMWS_SECRET_KEY` | ✅ Yes | Secure random key (32+ chars) | Use from .env file |
| `TMWS_ENVIRONMENT` | ⚠️ Recommended | Environment mode | `production` or `development` |
| `TMWS_VECTOR_DIMENSION` | ℹ️ Optional | Embedding dimension | `768` (default) |
| `TMWS_EMBEDDING_MODEL` | ℹ️ Optional | Embedding model | `intfloat/multilingual-e5-base` |

#### 4. Restart Claude Desktop

After configuration:

1. Quit Claude Desktop completely (⌘+Q on macOS)
2. Reopen Claude Desktop
3. The TMWS MCP server will auto-start via uvx

#### 5. Verify Installation

In Claude Desktop, test the connection:

```
Can you check if the TMWS MCP server is available?
```

Expected response: Claude should be able to access TMWS MCP tools like `store_memory`, `semantic_search`, etc.

## Troubleshooting

### MCP Server Not Starting

**Check Claude Desktop logs:**

```bash
# macOS
tail -f ~/Library/Logs/Claude/mcp*.log
```

**Common issues:**

1. **Database connection failed**
   - Verify `TMWS_DATABASE_URL` is correct
   - Check network connectivity to Supabase/PostgreSQL
   - Ensure pgvector extension is installed

2. **Redis connection failed**
   - Start Redis: `brew services start redis`
   - Verify Redis is running: `redis-cli ping`

3. **ChromaDB initialization failed**
   - Check directory permissions: `ls -la ~/.tmws-repo/data/chroma`
   - Manually initialize: `cd ~/.tmws-repo && uv run python scripts/initialize_chroma.py`

4. **uvx command not found**
   - Install uv: `curl -LsSf https://astral.sh/uv/install.sh | sh`
   - Restart terminal

### Manual Testing

Test MCP server directly:

```bash
cd ~/.tmws-repo
uv run python -c "from src.mcp_server import main; print('✅ Import successful')"
```

Test ChromaDB connection:

```bash
cd ~/.tmws-repo
uv run python scripts/initialize_chroma.py
```

Test database connection:

```bash
cd ~/.tmws-repo
uv run python -c "
import asyncio
from src.core.database import get_db_session
from src.core.config import settings

async def test():
    async for session in get_db_session():
        print(f'✅ Database connected: {settings.database_url}')
        break

asyncio.run(test())
"
```

## Updating TMWS

To update to the latest version:

```bash
cd ~/.tmws-repo
git pull
uv sync
uv run alembic upgrade head
```

Then restart Claude Desktop.

## Uninstallation

To remove TMWS MCP server:

1. Remove from Claude Desktop config:
   ```bash
   vim ~/Library/Application\ Support/Claude/claude_desktop_config.json
   # Delete the "tmws" section
   ```

2. Remove installation directory:
   ```bash
   rm -rf ~/.tmws-repo
   ```

3. Restart Claude Desktop

## Alternative: Development Directory Setup

If you want to use the development directory instead of `~/.tmws-repo`:

```json
{
  "mcpServers": {
    "tmws": {
      "command": "uvx",
      "args": [
        "--from",
        "/Users/yourusername/workspace/github.com/apto-as/tmws",
        "tmws-mcp-server"
      ],
      "env": {
        "TMWS_DATABASE_URL": "...",
        "TMWS_REDIS_URL": "..."
      }
    }
  }
}
```

**Note:** This approach uses your development directory, so changes to code will immediately affect the MCP server.

## Performance Expectations

After successful setup, you should see:

| Metric | Performance |
|--------|-------------|
| Vector Search | < 1ms P95 |
| Memory Store | < 2ms P95 |
| Agent Operations | < 1ms P95 |
| Task Operations | < 3ms P95 |

## Security Considerations

1. **Never commit `.env` or `claude_desktop_config.json`** to version control
2. **Use strong SECRET_KEY** (32+ random characters)
3. **Restrict database access** to necessary hosts only
4. **Use TLS for Redis** in production
5. **Regularly update dependencies**: `cd ~/.tmws-repo && uv sync --upgrade`

## Next Steps

- Read [MCP Tools Reference](MCP_TOOLS_REFERENCE.md) for available tools
- Check [Architecture Documentation](ARCHITECTURE_V2.3.0.md) for system design
- Review [Deployment Guide](DEPLOYMENT_GUIDE.md) for production setup
