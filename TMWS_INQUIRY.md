# TMWS開発チームへの問い合わせ事項

**問い合わせ日**: 2025-11-03
**問い合わせ元**: Trinitas統合チーム（Athena, Artemis, Hestia, Eris, Hera, Muses）
**目的**: Trinitas v2.3.0のTMWS統合実装における技術仕様確認

---

## 🔐 セキュリティ関連の確認事項（Priority: CRITICAL）

### 1. 認証・認可機構

#### Q1-1: MCP Serverの認証機構
**質問**: TMWS MCP Serverは認証機構を実装していますか？

**確認したい仕様**:
- [ ] API鍵ベースの認証が実装されているか
- [ ] 認証方法（Bearer Token / API Key / OAuth2 など）
- [ ] 認証ヘッダーのフォーマット（例: `Authorization: Bearer <token>`）
- [ ] API鍵の発行・管理方法
- [ ] 認証失敗時のレスポンス（ステータスコード、エラーメッセージ）

**理由**: Trinitasフックからの接続に認証を実装する必要があるため

**Hestiaのコメント**: "...認証なしでの運用は、全プロジェクトの記憶が漏洩するリスクがあります..."

---

#### Q1-2: プロジェクト間のアクセス制御
**質問**: プロジェクト間の記憶の分離はどのように実装されていますか？

**確認したい仕様**:
- [ ] `namespace` または `project_id` パラメータの存在
- [ ] プロジェクトIDの推奨フォーマット（例: `project-{hash}`, `{org}/{repo}`）
- [ ] クロスプロジェクトアクセスの制限方法
- [ ] `access_level` の実装状況（`private`, `team`, `shared`, `public`）
- [ ] タグベースのフィルタリングは自動適用されるか、クライアント側の責任か

**理由**:
```python
# 私たちの実装案
await memory_service.create_memory(
    content="...",
    tags=["project:trinitas-agents", "private"],  # ← これで分離できる？
    access_level="private"  # ← このパラメータは有効？
)
```

**Athenaのコメント**: "ふふ、プロジェクト間の調和を保つため、厳格な分離が必要ですね"

---

#### Q1-3: 機密情報の暗号化
**質問**: TMWS内部で記憶内容の暗号化は実装されていますか？

**確認したい仕様**:
- [ ] データベース内での暗号化（Encryption at Rest）
- [ ] 通信時の暗号化（TLS/SSL）
- [ ] クライアント側での事前暗号化が推奨されるか
- [ ] 暗号化されたコンテンツの検索可能性（暗号化すると検索できない？）

**理由**: パスワード、API鍵などの機密情報を安全に保存したい

**Hestiaのコメント**: "...機密情報は必ず暗号化すべきです。平文保存は絶対に避けてください..."

---

### 2. 入力検証とサニタイゼーション

#### Q2-1: SQLインジェクション/NoSQLインジェクション対策
**質問**: TMWS APIは入力検証を実装していますか？

**確認したい仕様**:
- [ ] `content`, `query`, `tags` などのパラメータに対する検証
- [ ] 特殊文字のエスケープ（`'`, `"`, `;`, `--`, etc.）
- [ ] 最大長の制限（DoS対策）
- [ ] クライアント側でのサニタイゼーションが必要か

**理由**:
```python
# ユーザー入力をそのまま送信しても安全か？
user_input = request.get("prompt")
await memory_service.create_memory(content=user_input)  # ← 安全？
```

---

#### Q2-2: XSS対策
**質問**: 記憶から取得したコンテンツはHTMLエスケープ済みですか？

**確認したい仕様**:
- [ ] APIレスポンスのコンテンツはエスケープ済みか
- [ ] クライアント側でのエスケープが必要か
- [ ] Markdown/HTMLコンテンツの扱い

---

### 3. DoS/リソース保護

#### Q3-1: レート制限
**質問**: TMWS APIにレート制限は実装されていますか？

**確認したい仕様**:
- [ ] レート制限の有無
- [ ] 制限値（例: 100 requests/分）
- [ ] 制限超過時のレスポンス（429 Too Many Requests?）
- [ ] `Retry-After` ヘッダーの提供
- [ ] クライアントIDごと or IPごと or API鍵ごと

**理由**: Trinitasフック側でもレート制限を実装すべきか判断したい

**Artemisのコメント**: "フン、サーバー側で制限があるなら、クライアント側の実装を最適化できるわ"

---

#### Q3-2: ペイロードサイズ制限
**質問**: 記憶のコンテンツサイズに制限はありますか？

**確認したい仕様**:
- [ ] `content` の最大サイズ（バイト数 or 文字数）
- [ ] `metadata` の最大サイズ
- [ ] `tags` の最大個数
- [ ] 制限超過時のエラーレスポンス

**理由**: 大きなコンテンツを分割して保存すべきか判断したい

---

### 4. 監査ログ

#### Q4-1: TMWS側の監査ログ
**質問**: TMWS MCP Serverは操作の監査ログを記録していますか？

**確認したい仕様**:
- [ ] 記録される操作（create, update, delete, search）
- [ ] ログに含まれる情報（タイムスタンプ, クライアントID, 操作内容）
- [ ] ログの保存期間
- [ ] ログへのアクセス方法（API? ファイル?）

**理由**: セキュリティインシデント発生時の調査に必要

**Hestiaのコメント**: "...監査ログは最悪のシナリオへの唯一の対抗手段です..."

---

## 🏗️ アーキテクチャ関連の確認事項（Priority: HIGH）

### 5. データベース設計

#### Q5-1: 実際のデータベース構成
**質問**: TMWSのデータベース構成を教えてください

**確認したい仕様**:
```
TRINITAS_INTEGRATION_SPECIFICATION.mdには以下の記載がありますが、
実装は異なる可能性があります：

Layer 1: SQLite (metadata, ACID, 2-5ms writes)
Layer 2: ChromaDB (vectors, 0.47ms search)
Layer 3: Redis (agent coordination, <1ms ops, 10min TTL)
```

**具体的な確認事項**:
- [ ] 実際に使用されているデータベース（SQLite? PostgreSQL?）
- [ ] ベクトルDBの種類（ChromaDB? Pinecone? Qdrant?）
- [ ] Redisの用途（セッション管理? キャッシュ?）
- [ ] データベースのロケーション（ローカル? リモート?）
- [ ] 接続方法（ファイルパス? URL?）

**理由**: フォールバック実装（TMWS障害時のローカル保存）の設計に影響

**Artemisのコメント**: "正確なアーキテクチャを知らないと、最適化できないわ"

---

#### Q5-2: インデックス戦略
**質問**: どのフィールドにインデックスが設定されていますか？

**確認したい仕様**:
- [ ] `tags` のインデックス（B-Tree? Hash?）
- [ ] `importance` のインデックス
- [ ] `created_at` / `updated_at` のインデックス
- [ ] 複合インデックスの有無

**理由**: クエリの最適化に必要

---

### 6. パフォーマンス

#### Q6-1: 実測パフォーマンス
**質問**: 実際のパフォーマンスメトリクスを教えてください

**TRINITAS_INTEGRATION_SPECIFICATION.mdの記載**:
- 検索: 0.47ms (P95)
- 書き込み: 2ms (P95)
- エンドツーエンド: <50ms

**確認したい実測値**:
- [ ] 実環境での検索レイテンシ（P50, P95, P99）
- [ ] 実環境での書き込みレイテンシ（P50, P95, P99）
- [ ] 同時接続数の上限
- [ ] メモリ使用量（アイドル時 vs ピーク時）
- [ ] ディスク使用量（1万レコードあたり）

**理由**:
```python
# 私たちの目標
Hook execution budget: <100ms total
TMWS search: <50ms (我々の予算の50%)
TMWS write (async): <0.1ms (fire-and-forget)

この目標は現実的ですか？
```

**Artemisのコメント**: "理論値と実測値のギャップを知りたい。パフォーマンスチューニングの鍵よ"

---

#### Q6-2: キャッシング戦略
**質問**: TMWS内部でキャッシングは実装されていますか？

**確認したい仕様**:
- [ ] 検索結果のキャッシュ（有効期間は？）
- [ ] キャッシュの無効化タイミング
- [ ] クライアント側でのキャッシングが推奨されるか
- [ ] Redis層の具体的な用途

**理由**: Trinitasフック側でLRUキャッシュ（100エントリ）を実装済み。重複を避けたい

---

### 7. MCP Tools仕様

#### Q7-1: memory_service.create_memory の詳細仕様
**質問**: `create_memory` の完全なパラメータ仕様を教えてください

**MCP_TOOLS_REFERENCE.mdの記載**:
```python
store_memory(
    content: str,
    importance: float = 0.5,
    tags: list[str] = [],
    namespace: str = "default",
    access_level: str = "private",
    metadata: dict = {}
) -> dict
```

**確認したい詳細**:
- [ ] `memory_type` パラメータは存在するか？（例: "decision", "learning", "context"）
- [ ] `persona_id` パラメータは存在するか？
- [ ] `project_id` パラメータは存在するか？
- [ ] 返り値の構造（`memory_id` のフォーマット、その他のフィールド）
- [ ] エラー時のレスポンス構造

**理由**:
```python
# 私たちの実装案
memory = await memory_service.create_memory(
    content="プロジェクトのアーキテクチャをマイクロサービスに変更します",
    memory_type="decision",  # ← このパラメータは有効？
    importance=0.9,
    tags=["architecture", "decision", "project:trinitas-agents"],
    persona_id="athena-conductor",  # ← これも有効？
    metadata={
        "decision_date": "2025-10-27",
        "decided_by": "Athena"
    }
)
```

---

#### Q7-2: memory_service.search_memories の詳細仕様
**質問**: `search_memories` の検索アルゴリズムを教えてください

**確認したい仕様**:
- [ ] `query` はセマンティック検索か？キーワード検索か？両方？
- [ ] `min_similarity` の範囲（0.0-1.0?）と推奨値
- [ ] `limit` の最大値
- [ ] 検索対象フィールド（`content` のみ? `tags` / `metadata` も？）
- [ ] 検索結果のソート順（類似度降順? 重要度降順? タイムスタンプ降順?）
- [ ] フィルタリングオプション（`tags`, `importance_threshold`, `time_range`）

**理由**: 検索クエリの最適化に必要

**Heraのコメント**: "検索精度が戦略的判断の質を左右する。正確な仕様が必要だ"

---

#### Q7-3: その他のMCP Tools
**質問**: 以下のツールの実装状況を教えてください

**確認したいツール**:
- [ ] `update_memory(memory_id, **updates)` - 記憶の更新
- [ ] `delete_memory(memory_id)` - 記憶の削除
- [ ] `get_memory(memory_id)` - 単一記憶の取得
- [ ] `export_memories(filters)` - バックアップ/エクスポート
- [ ] `import_memories(data)` - リストア/インポート

**理由**: フル機能を活用したい

---

### 8. エラーハンドリング

#### Q8-1: エラーレスポンスの形式
**質問**: エラー時のレスポンス構造を教えてください

**確認したい仕様**:
```python
# エラーレスポンスの例
{
    "error": {
        "code": "INVALID_PARAMETER",  # エラーコード
        "message": "content must be non-empty string",  # メッセージ
        "details": {...}  # 追加情報
    }
}
```

**具体的な確認事項**:
- [ ] HTTPステータスコード（400, 401, 403, 429, 500など）
- [ ] エラーコードの一覧
- [ ] エラーメッセージの言語（英語? 日本語?）
- [ ] `details` に含まれる情報

**理由**: 適切なエラーハンドリングとリトライロジックの実装に必要

---

#### Q8-2: タイムアウト時の挙動
**質問**: TMWS側のタイムアウト設定はありますか？

**確認したい仕様**:
- [ ] リクエストタイムアウト（サーバー側の制限）
- [ ] 長時間実行される操作（例: 大量データの検索）のタイムアウト
- [ ] タイムアウト時のレスポンス（504 Gateway Timeout?）

**理由**: クライアント側のタイムアウト設定（現在300ms）が適切か判断したい

---

## 🔄 統合関連の確認事項（Priority: MEDIUM）

### 9. セッション管理

#### Q9-1: セッションの概念
**質問**: TMWSには「セッション」の概念がありますか？

**確認したい仕様**:
- [ ] セッションID の管理
- [ ] セッションごとの記憶の分離
- [ ] セッション開始時の推奨フロー
- [ ] セッション終了時のクリーンアップ

**理由**:
```python
# 私たちの実装案
async def on_session_start(event):
    # 過去の記憶を復元
    memories = await tmws.search_memories(
        query=f"session:{last_session_id}",  # ← こういうクエリは有効？
        limit=10
    )
```

**Erisのコメント**: "セッション間の調整が私の役目。TMWSの仕様を知りたい"

---

### 10. ベクトル埋め込み

#### Q10-1: 埋め込みモデル
**質問**: TMWSで使用されているベクトル埋め込みモデルを教えてください

**TRINITAS_INTEGRATION_SPECIFICATION.mdの記載**:
- Multilingual-E5-large (768次元)

**確認したい仕様**:
- [ ] 実際のモデル名とバージョン
- [ ] ベクトル次元数
- [ ] 対応言語（日本語の精度は？）
- [ ] 埋め込み生成のレイテンシ

**理由**: セマンティック検索の精度に影響

---

#### Q10-2: カスタム埋め込み
**質問**: クライアント側で生成したベクトルを渡すことは可能ですか？

**確認したい仕様**:
- [ ] `embedding` パラメータの存在
- [ ] ベクトルのフォーマット（float32の配列?）
- [ ] カスタム埋め込みを使用するメリット

**理由**: 特殊なドメイン（コード、専門用語）での精度向上

---

### 11. バックアップとリカバリ

#### Q11-1: データのエクスポート
**質問**: TMWSのデータをエクスポートする方法はありますか？

**確認したい仕様**:
- [ ] エクスポートAPI（`export_memories`?）
- [ ] エクスポート形式（JSON? CSV? SQL dump?）
- [ ] 大量データのエクスポート方法（ページネーション?）

**理由**: バックアップとマイグレーションに必要

---

#### Q11-2: ディザスタリカバリ
**質問**: TMWSのバックアップ戦略を教えてください

**確認したい仕様**:
- [ ] 自動バックアップの有無
- [ ] バックアップの頻度
- [ ] リストア手順
- [ ] Point-in-time リカバリの可否

**理由**: 本番運用での信頼性確保

---

## 📊 運用関連の確認事項（Priority: LOW）

### 12. 監視とデバッグ

#### Q12-1: ヘルスチェック
**質問**: `/health` エンドポイントの仕様を教えてください

**確認したい仕様**:
```python
# 期待するレスポンス
{
    "status": "healthy",
    "version": "2.3.0",
    "uptime": 3600,
    "database": {
        "sqlite": "connected",
        "chromadb": "connected",
        "redis": "connected"
    },
    "metrics": {
        "total_memories": 1000,
        "total_agents": 10
    }
}
```

**確認したい詳細**:
- [ ] レスポンスの構造
- [ ] チェック対象（DB接続、ディスク容量など）
- [ ] ヘルスチェックのレイテンシ

---

#### Q12-2: メトリクスエンドポイント
**質問**: メトリクス取得用のエンドポイントはありますか？

**確認したい仕様**:
- [ ] Prometheus形式のメトリクス
- [ ] 取得可能なメトリクス（レイテンシ、スループット、エラー率など）
- [ ] `/metrics` エンドポイントの有無

**理由**: パフォーマンス監視とアラート設定に必要

---

### 13. 開発・テスト環境

#### Q13-1: テスト用のMock/Stub
**質問**: TMWS MCPのMock実装はありますか？

**確認したい仕様**:
- [ ] テスト用のMockサーバー
- [ ] インメモリモード（`:memory:`）
- [ ] テストデータのフィクスチャ

**理由**: Trinitasフックのユニットテストに必要

**Artemisのコメント**: "テストなしの実装はありえない。Mock実装が必要よ"

---

#### Q13-2: 開発環境のセットアップ
**質問**: TMWS開発環境のセットアップ手順を教えてください

**確認したい情報**:
- [ ] 最小システム要件（CPU, メモリ, ディスク）
- [ ] 依存関係のインストール方法
- [ ] 設定ファイルのサンプル
- [ ] 初期データのロード方法

**理由**: Trinitasチーム全員が同じ環境で開発したい

---

## 🎯 優先順位のまとめ

### 🔴 CRITICAL（即座に必要）
1. **認証機構（Q1-1）** - 実装の前提条件
2. **プロジェクト間のアクセス制御（Q1-2）** - データ漏洩防止
3. **機密情報の暗号化（Q1-3）** - セキュリティの基本
4. **create_memory の詳細仕様（Q7-1）** - 実装の核心
5. **search_memories の詳細仕様（Q7-2）** - 機能の核心

### 🟠 HIGH（1週間以内に必要）
6. 実際のデータベース構成（Q5-1）
7. 実測パフォーマンス（Q6-1）
8. エラーレスポンスの形式（Q8-1）
9. レート制限（Q3-1）
10. 入力検証とサニタイゼーション（Q2-1）

### 🟡 MEDIUM（2週間以内に必要）
11. セッション管理（Q9-1）
12. キャッシング戦略（Q6-2）
13. 監査ログ（Q4-1）
14. その他のMCP Tools（Q7-3）
15. ベクトル埋め込み（Q10-1）

### 🟢 LOW（1ヶ月以内）
16. バックアップとリカバリ（Q11-1, Q11-2）
17. 監視とデバッグ（Q12-1, Q12-2）
18. 開発・テスト環境（Q13-1, Q13-2）

---

## 📝 回答フォーマットの提案

お手数ですが、以下のようなフォーマットでご回答いただけると助かります：

```markdown
### Q1-1: MCP Serverの認証機構

**実装状況**: ✅ 実装済み / ⚠️ 部分的 / ❌ 未実装

**認証方法**: Bearer Token

**使用例**:
```python
headers = {"Authorization": f"Bearer {api_key}"}
response = await client.post("/api/v1/memories", headers=headers, json=data)
```

**補足説明**: ...
```

---

## 🤝 Trinitasチームより

この問い合わせは、Trinitasシステムの6つのペルソナ全員の協力により作成されました：

- **Athena**: 全体の調和と調整
- **Artemis**: 技術的詳細とパフォーマンス
- **Hestia**: セキュリティと最悪シナリオ
- **Eris**: セッション間の調整
- **Hera**: 戦略的優先順位
- **Muses**: ドキュメント化と知識管理

TMWS開発チームの皆様の専門知識と経験を、心より尊重しております。

どうぞよろしくお願いいたします。

---

**最終更新**: 2025-11-03
**問い合わせID**: TMWS-INQUIRY-20251103
**優先度**: HIGH
**期待する回答期限**: 可能な限り早く（特にCRITICAL項目）
